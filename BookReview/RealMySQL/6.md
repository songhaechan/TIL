데이터 압축
=

MySQL의 디스크는 쿼리 성능과도 직결되지만 백업 및 복구에도 밀접한 연관이있다.

데이터파일이 크면 더 많은 데이터페이지를 읽어야할 수 있고 더 자주 플러시돼야한다.

파일이 크면 백업시간도 오래걸리며 비용문제도 발생한다.

데이터를 압축하는 방식에는 크게 **테이블 압축, 페이지 압축**이 있다.

## 페이지 압축

데이터 페이지는 디스크에 기록될때 버퍼풀에서 압축 후 기록되고 버퍼풀로 올라올 때 압축이 해제된다.

하지만 16KB의 데이터페이지를 압축한 결과를 예측할 수 없다는 것이 문제인데 이 문제는 **펀치 홀**로 해결한다.

16KB를 7KB로 압축했다면 9KB의 빈데이터를 생성해 디스크에 기록하고 이후에 운영체제에 9KB를 반납한다.

하지만 16KB(데이터 페이지)를 읽으면 9KB까지 같이 읽는다.

하지만 펀치 홀이 적용돼 데이터의 크기가 줄었다고하더라도 백업이나 복사를하게되면 펀치홀이 다시 채워지기때문에 데이터가 원본 크기와 같아진다는 문제점이있다.

이런 문제점으로 페이지 압축은 잘 사용하지않는다.

## 테이블 압축

페이지 압축과 달리 운영체제나 하드웨어에대한 제약 없이 사용할 수 있다.

몇 가지 단점이 있지만 우선 원리를 알아보자.

우선 테이블 압축은 **별도의 테이블 스페이스**를 사용해야한다.

innodb_file_per table 을 ON으로 설정하고 ROW FORMAT=COMPRESSED로 설정한다.

추가로 KEY_BLOCK_SIZE를 명시해 압축된 페이지의 크기를 설정할 수 있다. (크기는 2n n은 2 이상)

만약 페이지크기가 16KB이면 타깃 페이지는 4KB 8KB 로만 설정이 가능하다.
>페이지 크기가 32KB, 64KB인 경우 테이블압축이 불가능하다.

테이블 압축의 작동 방식을 알아보자

1. 16KB의 데이터페이지가 주어짐
2. 압축 적용
3. 압축 결과가 타깃페이지크기보다 큰지 작은지 판단
4. 작다면 그대로 디스크에 저장
5. 크다면 원본 페이지를 2개로 split 후 2개의 페이지에 8KB씩 저장
6. 다시 1번으로 돌아가 반복

목표크기의 설정이 잘못돼면 이 과정의 반복이 늘어나면서 서버처리성능이 급격히 떨어질 수 있으니 주의하자.

## KEY_BLOCK_SIZE 결정

테스트 데이터를 이용해서 압축을 테스트하는 방법이 좋다.

자세한 테스트 방법은 책을 참고하고 중요한 부분을 정리해보자.(p.190)

인덱스별로 압축시도횟수와 실패횟수가 나온다. 그리고 실패율을 보여주는데 여기서 실패란 압축결과가 타깃페이지크기(KEY_BLOCK_SIZE)를 넘어가서 다시 압축을 시도했다는 의미다.

그만큼 압축과정이 2배로 늘어나기때문에 실패율은 3~5%로 유지하는 것이 좋다.

그렇다면 KEY_BLOCK_SIZE를 변경하면 압축 실패율을 무조건 낮출 수 있을까?

답은 아니다. 일반적으로 그렇겠지만 그렇지않은 경우도 있는데 이 경우 성능에 민감한 서비스라면 해당 테이블은 압축을 적용하지않는 것이 좋을 수 있다.

고려할 지표는 **압축 후 얼마나 데이터크기가 얼마나 줄었는지(압축효율), 압축 실패율은 얼마나 낮은지(성능)이다.**

## 압축된 페이지의 버퍼 풀 적재 및 사용

InnoDB는 압축된 페이지와 압축이 해제된 페이지 2가지 모두를 관리한다.

일반 LRU리스트에는 압축된 페이지 Unzip_LRU에는 압축이 해제된 페이지를 관리한다.

>Unzip_LRU는 압축되지않은 테이블의 데이터는 가지지않는다.

이렇게 이중으로 데이터를 관리하기때문에 첫째로 메모리공간을 낭비하고, 압축된 페이지에서 데이터를 읽거나 변경하면 압축을 해제해야하는데 압축 및 해제는 CPU소모량이 크다.

이를 위해 아래와같은 처리를 거친다.

- 버퍼풀의 공간이 필요하면 LRU에서 압축된 형태는 유지하고 Unzip_LUR에서 압축해제된 버전은 제거해 버퍼풀의 공간을 확보한다.

- 압축된 페이지가 자주 사용되면 Unzip_LRU리스트에 압축 해제된 페이지를 계속 유지한다.

- LRU에서 제거되면 Unzip_LRU에서도 제거된다.

- cpu사용량이 많은 서비스라면 Unzip_LRU비율을 높인다
- Dis I/O가 많다면 Unzip_LRU 비율을 낮춘다.
