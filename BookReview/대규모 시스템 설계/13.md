검색어 자동완성 시스템
=

네이버나 구글 검색창에 몇 단어를 타이핑하면 자동으로 단어를 완성시켜주는 시스템을 본적이 있을 것이다.

이 시스템을 설계해보자.

## 설계 범위 확정

- 일단은 영어만 지원한다.
- 자동완성 검색어의 개수는 5개다.
- 일간 능동 사용자는 천만명이다.
- 영소문자만 취급한다.

## 요구사항

직접 경험해봐서 알겠지만 정말 매우 매우 빠른 응답속도를 보여야한다.

인기순으로 검색어를 표출해야한다.(정렬 필요)

일간 천만명의 요청을 감당할 규모의 확장성을 고려해야한다.

시스템장애에도 계속 사용가능해야한다.

## 개략적 설계

크게 두가지로 나눌 수 있다.

- 데이터 수집 서비스
    
    사용자의 데이터를 실시간으로 수집한다.
    (비효율적이지만 우선은 실시간으로 수집)

- 질의 서비스

    질의에 알맞은 인기 검색어를 정렬해 내놓는 서비스다.

    빈도를 기록하고 RDB에서 상위 5개의 조회결과를 반환한다.

## 상세설계

이제 개략적 설계안을 최적화해보자.

- 트라이 자료구조
- 데이터 수집 서비스
- 질의 서비스
- 규모 확장이 가능한 저장소
- 트라이 연산

### 트라이 자료구조

루트 노드 : 빈 문자열

자식 노드 : 접두어나 단어 (주로 말단 노드가 단어)

여기에 빈도수까지 말단 노드에 함께 기록해야한다.

질의어는 접두어를 표현하는 노드를 찾고, 해당 노드부터 하위트리를 탐색해 모든 노드를 찾는다.

찾아낸 노드들 중에서 빈도수를 정렬해 5개의 결과를 반환한다.

하지만 최악의 경우에 모든 트라이를 다 탐색할 수도 있다.(반환하는 인기검색어가 많아질때)

### 해결책

1. 접두어의 최대 길이를 제한

    사용자는 주로 짧은 단어를 입력한다 따라서 최대 길이를 제한해도 안전하다.

2. 인기 검색어 캐시

    접두어 노드에 인기검색어를 캐시해두면 하위노드를 탐색할 필요가 없기때문에 성능이 향상된다.

## 데이터 수집 서비스

개략적 설계안에서는 실시간 수집을 했지만 일간 천만 사용자의 모든 요청을 실시간 수집하기란 불가능에 가깝다.(가능해도 성능이 떨어진다.)

일단 트라이가 만들어지면 갱신이 자주 일어날 상황은 많지않다.

- 사용자의 검색을 로그기록으로 남긴다.
- 사용자의 로그를 취합한다.(기간은 일주일, 실시간성이 중요하다면 더 짧게 가져가야한다.)
- 주기적으로 비동기적 작업을 실행한다.(트라이 구조를 실제 데이터베이스에 저장)

## 질의 서비스

모든 서비스와 비슷하다.

- 로드밸런서가 질의를 웹서버로 전송한다.
- 우선 트라이 캐시를 조회한다.
- 캐시에 없다면 데이터베이스에서 가져온다.

질의 서비스는 매우매우 빨라야한다고했다.

보통 **AJAX 요청**을 많이 사용한다. 페이지를 리로딩하지않고 바로 요청만 보내기때문이다.

**브라우저 캐싱** 자동완성 결과는 자주바뀌지않는다(?) 후속질의는 브라우저에서 계속 가져간다.

## 트라이 연산

로그 데이터베이스로부터 취합한 데이터를 기반으로 새로운 트라이를 만들어 기존 트라이를 대체한다.

혐오성, 폭력적 검색어는 필터 계층을 두고 반환하지않는다.

## 저장소 규모 확장

규모의 확장은 샤딩을 이용한다.

a-z까지의 검색어 접두어를 키로하고 샤드 서버의 개수를 결정해 나눈다.

데이터를 균등하게 배분하기위해선 검색어 대응 샤드 관리자를 도입해 a-? 까지의 검색어 결과와 ?-? 까지의 검색어 결과의 크기를 계산해서 샤드의 배분을 어느정도 균일하게 만들 수 있다.