알림 시스템 설계
=

## 알림 유형별 지원 방안

순서도

알림 제공자 -> 제 3자 서비스 -> 사용자 단말

### ios 푸시 알림

**알림 제공자**는 **알림 요청**을 만들어 APNS(애플이 제공하는 알림 시스템)에 전달한다.

알림 요청은 **단말 토큰(고유식별자)**, **페이로드(알림 내용을 담은 JSON)** 가 필요하다.

APNS가 최종적으로 사용자에게 알림을 보낸다.

### Android 푸시 알림

APNS가 FCM으로 바뀐것 이외엔 차이점이 없다.

### SMS 메세지

APNS, FCM이 모바일을 위한 서비스였다면 SMS는 트윌리오, 넥스모 같은 제 3자 서비스를 이용한다.

### 이메일

제 3자 서비스로 센드그리드 메일침프등을 이용한다.

## 연락처 정보 수집 절차

사용자의 정보를 데이터베이스에(가입 시)저장하고 API가 호출해 사용한다.

## 개략적 설계안

1. 서비스는 N개 존재한다.(마이크로서비스일 수도 있고 분산 시스템의 컴포넌트일 수도 있다.)

쇼핑몰을 예로들자면 배송정보알림, 결제알림 등 하나의 시스템에도 다양한 서비스가 알림을 보낼 수 있다.

2. 알림시스템은 N개의 서비스가 공통으로 사용하는 **단일 서버**로 구성한다. 앞서 살펴봤듯이 알림을 보내는 API를 제공하고 페이로드를 만들 수 있어야한다.

3. 제 3자 서비스에 요청을 보낸다.

4. 제 3자 서비스가 사용자 단말에 알림을 보낸다.

### 위 설계의 문제점

우선 알림시스템이 **단일 서버**로 구성돼있기때문에 SPOF문제가 발생한다.

알림시스템을 단일 서버로 구성하면 데이터베이스나 캐시등 모두 한 서버에서 이루어지기때문에 수평적 확장이 불가능하다.

## 개선된 설계안

- 단일 서버로 구성된 알림시스템에서 DB와 캐시를 분리한다.

- 알림시스템 서버 자체를 증설,삭제가 가능하도록 설계한다.(안정 해시설계가 좋을 듯 하다)

- ios, 안드로이드, sms, 이메일 각각 작업서버를 따로 생성하고 메세지 큐를 생성해 강한 결합을 끊는다.

> 강한 결합을 끊어낸다는 것은 알림서버와 작업서버 사이의 결합을 끊는다는 것이다. 메세지 큐를 도입하면 알림서버에 직접 접근하지않아도 되며 알림 서버가 죽는다 하더라도 큐에 작업이 남아있다면 정상처리가 가능하기때문이다.(다른 알림서버가 대신 메세지 큐에 작업을 넣도록 수평적확장 설계를 도입하면 된다.)

- 알림서버의 기능

인증된 클라이언트, 사내 서비스만 허용한다.

이메일 주소, 전화번호를 검증한다.

알림에 포함시킬 데이터베이스 캐시를 질의한다.

알림 데이터를 메시지 큐에 넣는다. (병렬 처리 가능)

## 전체적인 흐름


1. API를 호출해 알림 서버로 알림을 보낸다

2. 알림 서버는 사용자 정보, 단말 토큰, 알림 설정 과같은 메타데이터를 캐시나 데이터베이스에서 가져온다.

3. 알림 서버는 알림에 맞는 이벤트를 만들어 큐에 넣는다.

4. 작업 서버는 큐에서 작업을 꺼내 제 3자 서비스로 보낸다.

5. 제 3자 서비스는 단말로 알림을 전송한다.

## 상세 설계

### 안정성

#### 데이터 손실 방지

알림은 늦게가도 상관은 없지만 절대 **소실**돼서는 안된다.

이를 방지하기위해 **작업 서버**에 알림 로그 데이터베이스를 따로 만들어둔다.

알림 로그를 통해 전송에 실패한 알림은 다시 재전송한다.

#### 중복 전송 방지

알림 로그를 통해 이전에 보낸적 있는지 확인하고 전송한다.

### 추가로 필요한 컴포넌트

#### 알림 템플릿

알림의 형식은 대부분 비슷하다. 이 형식을 템플리으로 저장해두고 재사용한다면 알림을 작성하는데 많은 시간을 들이지않아도 된다.

#### 알림 설정

알림을 보내기 이전에 알림을 받는 사용자인지 받지 않는 사용자인지 항상 체크해야한다.

#### 전송률 제한

너무 많은 알림은 사용자를 피곤하게한다. 하루에 한도를 정해놓고 알림을 보내는 것이 좋다.

#### 재시도 방법

알림 전송에 시패한다면 재시도 전용 큐에 넣는다.

#### 큐 모니터링

큐에 작업이 많이 쌓여있다면 이벤트 처리에 문제가 있다는 것이다.

큐를 증설해야하는 신호이다.

#### 이벤트 추적

알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율 같은 정보를 이해하는 것이 중요하다.

실제로 알림 서비스는 데이터 분석 서비스와도 통합한다.






