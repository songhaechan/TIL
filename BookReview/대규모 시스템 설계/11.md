뉴스 피드 시스템 설계
=

인스타그램이나 페이스북에서 보여지는 친구들의 게시글들을 표시하는 화면을 뉴스 피드라 부른다.

가장 중요한 설계부분은 **피드 발행**과 **피드 생성** 두 가지로 나뉘어있다.

## 상세 설계 (개략적 설계는 간단하므로 생략)

### 피드 발행 흐름

인스타그램에 게시글을 올리는 것을 연상하면 된다.

1. 사용자가 DNS에 IP를 요청하고 해당 IP를 이용해 로드밸런서에 요청

2. 사용자는 인증정보를 포함해 전송해야한다.

3. 웹서버는 **인증**,**처리율 제한**등을 거치도록 구성한다.

4. 포스팅 전송

    팬아웃(푸시 모델, 풀 모델)

    - 푸시 모델

        쓰기 시점에 뉴스 피드를 갱신한다. 포스팅이 완료되면 사용자의 캐시에 해당 포스트를 기록한다.

        장점 : 실시간으로 갱신되기때문에 친구 목록에 있는 사용자에게 즉시 전송, 포스팅이 되는 순간에 갱신되므로 피드를 읽는 시간이 짧아진다.

        단점 : 친구가 많다면 그만큼 피드를 갱신하는 시간이 길어진다(핫키문제), 서비스를 자주 사용하지않는 사용자까지 갱신해야하므로 자원낭비

    - 풀 모델

        피드를 읽는 시점에 피드를 갱신한다.
        즉 요청이 들어올 때 피드를 갱신한다.

        장점 : 비활성화된 사용자들의 피드를 갱신할 필요가 없어진다, 피드 생성시점에 친구들에게 푸시하지않기때문에 핫키문제가 없어진다.

        단점 : 뉴스 피드를 읽는 데 많은 시간이 걸린다.

### 푸시, 풀 모델 정리

푸시 모델은 게시글을 작성하는 시점에 친구들의 피드 모두 갱신해야한다.

친구가 매우 많다면 그 친구들이 모두 활성화된 사용자가 아니더라도 미리 갱신해야하기때문에 자원 낭비가 심하다.

하지만 다른 친구들이 피드를 읽을땐 이미 갱신돼있기때문에 짧은 지연시간을 가질 수 있다.

풀 모델은 피드를 요청해야지만 갱신이 된다.

친구가 많아도 미리 갱신하지않기때문에 비활성화된 친구들의 피드까지 갱신는 자원을 소모하지않을 수 있다.

하지만 미리 갱신하지 않기때문에 친구가 피드를 요청한다면 그만큼 지연시간은 길어진다.

### 결론
기본적으로 뉴스 피드를 빠르게 가져오는 것은 중요하기에 **푸시 모델**을 사용한다.

하지만 친구가 매우 많은 사용자는 팔로어로 하여금 필요할때만 가져가도록하는 **풀 모델**을 사용한다.

결과적으로 두 모델을 병행해서 사용한다.

### 팬아웃 서비스 흐름

1. 그래프 데이터베이스에서 친구 ID를 가져온다.

2. 친구들의 정보는 따로 캐시하고있는 서버에서 가져온다. 새롭게 추가된 친구는 사용자 정보 데이터베이스에 새롭게 질의한다.

3. 보기 싫은 친구는 제외하여 가져온다.

4. 친구 목록과 새 포스팅 ID를 메시지 큐에 넣는다.

5. 팬아웃 작업 서버가 메세지 큐에서 작업을 꺼내 새롭게 <포스팅ID, 사용자ID> 순으로 저장한다.

나의 새로운 게시글과 친구들의 새로운 게시글을 쓰기시점에 미리 캐시메모리에 넣고 바로 갱신하는 모델이다.

## 피드 읽기 흐름

CDN에 컨텐츠를 저장해 빨리 읽을 수 있도록한다.(이미지,영상)

1. 사용자가 피드읽기 요청을 보낸다.

2. 로드벨런서가 웹서버에게 요청을 보낸다.

3. 웹서버는 피드를 가져오기위해 뉴스 피드 서비스 호출

4. 뉴스 피드 캐시에서 포스팅 정보들을 가져온다.(미리미리 갱신돼있다.)

5. 실제 친구들의 정보와 게시글의 정보는 캐시서버에서 가져오고 없다면 데이터베이스에 새롭게 질의한다.