안정 해시 설계
=

앞장에서 샤딩을 통해 샤드에 데이터를 골고루 분포시켜야하는 이유를 알아보았다.

샤드에 데이터를 분포시키는 해시함수의 설계가 매우 중요하다는 것인데, 또 중요한 것은 하나의 샤드가 죽는다면 죽은 샤드의 데이터를 어떻게 분포시킬 것인지다.

hash(key) % N 을 통해 샤드에 데이터를 골고루 분포시킨다.

4개의 샤드가 있을 때 이중 한 샤드가 죽으면 N은 4가 아닌 3이 된다.

이때 키의 해쉬값은 변하지않지만 N이 변하기때문에 기존 키들이 서로 다른 샤드에 위치하게된다(재배치의 문제점)

결국 대규모 캐시미스가 발생한다.

## 안정 해시

전통적인 해시 테이블은 슬롯 수가 바뀌면 거의 모든 키를 재배치하지만 안정 해시는 k/n개의 키만 재배치한다.

k는 키의 개수이고 n은 슬롯의 개수다.

이게 어떻게 가능한지 알아보자.

물리적인 배열 공간을 생각해보자.

슬롯은 2에160승 - 1 개가 있다.

이 배열 공간을 동그랗게 말아서 논리적으로 원형을 만든다.

해시 링을 만들고 링위에 서버를 배치한다.

그리고 키를 해시 링에 배치한다.

안정 해시는 나머지연산을 통해 서버에 키를 배치시키는것이 아님을 주의하자.

키의 저장은 시계방향으로 가다가 만나는 첫번째 서버에 저장된다.

이때 한 서버가 죽으면 해당 서버에 할당된 키들은 시계방향으로 가서 만나는 다음 서버에 재할당된다.

**나머지 키들은 기존 서버에 그대로 배치돼있다.**

## 안정 해시의 문제점

1. 해시링에서 한 서버가 죽으면 각 서버가 관리하는 슬롯의 개수에 차이가 발생한다.

2. 키 자체를 균등하게 분포시키는 것이 어렵다.

## 해결책

가상 서버를 만들어 해시 링에 분포시킨다.

s1 s2 s3 가 기존 서버이고 s1.1 s2.1 s3.1을 해시링에 가짜 서버로 만들어둔다.

이 가상 서버가 많을 수록 표준편차가 줄어들어 각 서버가 관리하는 슬롯의 개수를 균등하게 만들고 자연스럽게 키 자체도 균등하게 분포된다.(1,2번 문제 해결)

**하지만!!**

안정 해시를 더욱 안정적으로 만들겠다고 가상 서버를 많이 생성하면 가상 서버의 데이터를 더 많이 생성해야한다.

트레이드오프관계에 놓여있는 것이다.

편차를 줄일 수록 데이터가 많이 필요하고, 편차를 높일 수록 안정적인 설계는 어려워진다.

시스템 요구사항에 맞게 적절히 조정해야한다.

