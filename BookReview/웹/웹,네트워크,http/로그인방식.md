쿠키를 사용한 로그인 방식
=

쿠키는 브라우저가 소규모 데이터를 저장할 수 있는 공간이다.

쿠키를 이용한 로그인 방식(상태유지)을 알아보자.

1. 사용자의 로그인 정보를 브라우저가 서버에 전송

2. 서버는 로그인정보를 set-cookie로 헤더에 포함시켜 브라우저에 전송

3. 브라우저는 쿠키를 저장하고 모든 요청에 쿠키를 헤더에 포함.

> 여기서 쿠키는 세션쿠키, 영속쿠키가 있는데, 만료 날짜가 없는 쿠키는 세션쿠키(브라우저를 닫으면 쿠키제거) 만료 날짜가 있으면 영속쿠키가 된다.

모든 요청에 로그인정보를 전달하면 보안상으로 매우 취약하다.

또한 쿠키는 브라우저 측에 저장되고 쿠키를 조회하는것이 매우 간단하기에 저장방식 자체에 보안 문제가있다.

세션을 통한 로그인 방식
=

세션을 통한다해서 쿠키와 완전 별개가 아니다.

쿠키에 기반한 세션방식이라 보는것이 맞다.

1. 사용자의 로그인 정보를 브라우저가 서버에 전송

2. 서버는 key value로 key에는 세션 ID value에는 정보를 기록하고 key(세션ID)만 브라우저에 쿠키로 전송한다.

3. 브라우저는 세션ID를 쿠키에 저장하고 모든 요청에 세션 ID를 포함시킨다.

세션 하이잭킹이 발생하더라도 HTTPS를 사용하면 해결이 가능하다.

요청을 TLS기반 공개키로 암호화하면 개인키로만 복호화가 가능하기때문이다.

JWT 기반 로그인 방식
=

JWT는 세 부분으로 나뉘어있다.

### Header

암호화할 해싱 알고리즘 및 토큰 유형

### Payload

데이터를 담는다. (민감한 정보는 담지 않아야한다.)

### Signature

인코딩된 헤더와 페이로드를 더한뒤 비밀키로 해싱하여 생성한다.

서버의 비밀키가 유출되지않는한 복호화할 수 없다.

1. 사용자의 로그인 정보를 서버에 전송

2. 로그인 정보를 기반으로 (비밀번호X) 토큰을 생성한 뒤 브라우저에 전송

3. 로컬스토리지나 세션스토리지 혹은 쿠키에 토큰을 브라우저가 저장한다.

서버는 토큰을 검증만 할 뿐 브라우저가 토큰을 보유한다.

모든 요청에 Authorization 헤더에 토큰을 포함시킨다.

### 단점과 해결책

우선 결론부터 말하자면 굉장히 취약한 방식이라 생각한다. 완벽한 보안은 없다는 생각이 들었다.

일단 보안에 대비해 액세스토큰의 만료기간을 매우 짧게하면 사용자가 자주 로그인해야하는 불편함이있다.

하지만 아무리 기간을 짧게 설정해도 토큰 자체가 탈취당하면 stateless한 설계상 서버측은 어쩔 도리가 없다.

그래서 리프래쉬 토큰을 발행해 해당 토큰으로 액세스토큰이 만료되면 리프래쉬토큰으로 액세스토큰을 발행받는다.

리프래쉬 토큰은 액세스토큰보단 만료기간이 길다.

하지만 리프래쉬 토큰도 JWT방식이라면 stateless하기에 서버측이 관리하지않고 이 토큰도 탈취당하면 방법이 없다.

물론 액세스 토큰이 만료되기도 이전에 리프래쉬 토큰으로 발행받겠다는 사용자가 있다면 비정상적인 접근으로 막을 수는 있다.(별도의 데이터베이스가 필요 Stateless하지 않다.)

하지만 액세스 토큰의 만료시점을 알고있는 해커라면 충분히 액세스토큰을 발급받을 수 있다.

여기서 리프래쉬토큰을 단 한번만 발행받게하고 매번 새로운 토큰을 발급받게하는 방식이있다.

하지만 이 방식도 사용되기 전의 리프래쉬토큰이라면 방법이 없다.

완전한 무상태 설계를 지향하면서 완전한 보안을 원하기는 굉장히 어려운 것 같다...





